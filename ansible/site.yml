- name: Configure Spark Cluster
  hosts: spark_cluster
  become: yes

  vars:
    spark_version: "2.4.3"
    spark_url: "https://archive.apache.org/dist/spark/spark-2.4.3/spark-2.4.3-bin-hadoop2.7.tgz"
    spark_master_ip: "10.0.0.3"

  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Java 8 (recommended for Spark 2.4.3)
      apt:
        name: openjdk-8-jdk
        state: present

    - name: Install dependencies
      apt:
        name:
          - wget
          - tar
        state: present

    # Reset Spark Install
    - name: Remove old spark installation
      file:
        path: /opt/spark
        state: absent

    - name: Download Spark 2.4.3
      get_url:
        url: "{{ spark_url }}"
        dest: /tmp/spark.tgz

    # Extract raw archive into /opt
    - name: Extract Spark (no strip)
      unarchive:
        src: /tmp/spark.tgz
        dest: /opt
        remote_src: yes

    # Detect real spark folder (guaranteed to work even if archive changes)
    - name: Detect Spark extracted directory
      shell: "ls -d /opt/spark-2.4.3*"
      register: spark_dir

    - name: Move Spark to /opt/spark
      command: mv {{ spark_dir.stdout }} /opt/spark
      args:
        creates: /opt/spark

    - name: Ensure jars directory exists
      file:
        path: /opt/spark/jars
        state: directory
        mode: "0755"

    - name: Set Spark environment variables
      lineinfile:
        path: /home/ubuntu/.bashrc
        line: |
          export SPARK_HOME=/opt/spark
          export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin
        create: yes

    - name: Download correct GCS Connector for Hadoop2 (Spark 2.4.3 compatibility)
      get_url:
        url: "https://storage.googleapis.com/hadoop-lib/gcs/gcs-connector-hadoop2-2.2.5.jar"
        dest: /opt/spark/jars/gcs-connector-hadoop2.jar
        mode: '0644'

    - name: Remove wrong Hadoop3 GCS connectors
      shell: rm -f /opt/spark/jars/gcs-connector-hadoop3*.jar

    # STOP services cleanly
    - name: Stop Spark Master if running and clean PID files
      shell: |
        /opt/spark/sbin/stop-master.sh
        rm -f /opt/spark/logs/spark-*.pid
      failed_when: false
      changed_when: false # Prevent reporting a change unless strictly necessary
      when: "'master' in group_names"

    - name: Stop Spark Worker if running and clean PID files
      shell: |
        /opt/spark/sbin/stop-slave.sh
        rm -f /opt/spark/logs/spark-*.pid
      failed_when: false
      changed_when: false
      when: "'workers' in group_names"

    # START MASTER
    - name: Start Spark Master
      shell: "/opt/spark/sbin/start-master.sh"
      when: "'master' in group_names"

    # START WORKER (Spark 2.x = start-slave)
    - name: Start Spark Worker
      shell: "/opt/spark/sbin/start-slave.sh spark://{{ spark_master_ip }}:7077"
      when: "'workers' in group_names"
